# v0_bash_agent_glm.py ä»£ç ç²¾è¯»

**GLM-4 ç‰ˆæœ¬çš„ Bash Agent å®Œæ•´è§£æ**

---

## ç›®å½•

1. [æ–‡ä»¶å¤´ä¸å¯¼å…¥](#1-æ–‡ä»¶å¤´ä¸å¯¼å…¥)
2. [ç¯å¢ƒé…ç½®](#2-ç¯å¢ƒé…ç½®)
3. [å·¥å…·å®šä¹‰](#3-å·¥å…·å®šä¹‰)
4. [System Prompt](#4-system-prompt)
5. [è¾…åŠ©å‡½æ•°](#5-è¾…åŠ©å‡½æ•°)
6. [æ ¸å¿ƒå¾ªç¯ï¼šchat å‡½æ•°](#6-æ ¸å¿ƒå¾ªç¯chat-å‡½æ•°)
7. [ä¸»ç¨‹åºå…¥å£](#7-ä¸»ç¨‹åºå…¥å£)
8. [å®Œæ•´æµç¨‹å›¾](#8-å®Œæ•´æµç¨‹å›¾)

---

## 1. æ–‡ä»¶å¤´ä¸å¯¼å…¥

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
v0_bash_agent_glm.py - Mini Claude Code: Bash å°±æ˜¯ä¸€åˆ‡ (GLM-4 ç‰ˆæœ¬)

ä½¿ç”¨æ™ºè°± GLM-4.7 API çš„ç‰ˆæœ¬
"""
```

### è§£æ

| ä»£ç  | ä½œç”¨ |
|------|------|
| `#!/usr/bin/env python` | Shebangï¼šå‘Šè¯‰ç³»ç»Ÿç”¨å“ªä¸ªè§£é‡Šå™¨æ‰§è¡Œæ­¤è„šæœ¬ |
| `# -*- coding: utf-8 -*-` | å£°æ˜æ–‡ä»¶ç¼–ç ä¸º UTF-8ï¼Œæ”¯æŒä¸­æ–‡ |
| ä¸‰å¼•å·å­—ç¬¦ä¸² | æ¨¡å—æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œè¯´æ˜æ–‡ä»¶ç”¨é€” |

### Shebang è¯¦è§£

```
å½“ä½ åœ¨ç»ˆç«¯æ‰§è¡Œ: ./v0_bash_agent_glm.py
                    â†“
         æ“ä½œç³»ç»Ÿè¯»å–ç¬¬ä¸€è¡Œ #!/usr/bin/env python
                    â†“
         åœ¨ PATH ä¸­æŸ¥æ‰¾ python è§£é‡Šå™¨
                    â†“
         ç›¸å½“äºæ‰§è¡Œ: python ./v0_bash_agent_glm.py
```

---

## 2. ç¯å¢ƒé…ç½®

```python
import sys
import os
import json

# ä¿®å¤ locale ç¼–ç é—®é¢˜ï¼ˆmacOS/Linuxï¼‰
if sys.platform != "win32":
    import locale
    if locale.getpreferredencoding().lower() != "utf-8":
        os.environ["LANG"] = "en_US.UTF-8"
        os.environ["LC_ALL"] = "en_US.UTF-8"

from openai import OpenAI
from dotenv import load_dotenv
import subprocess

load_dotenv(override=True)
```

### å¯¼å…¥é¡ºåºçš„é‡è¦æ€§

```
æ ‡å‡†åº“ â†’ ç¬¬ä¸‰æ–¹åº“ â†’ æœ¬åœ°æ¨¡å—
  â†“         â†“           â†“
sys,os   OpenAI     (æœ¬ä¾‹æ— )
json    dotenv
       subprocess
```

### Locale ä¿®å¤è¯¦è§£

```python
# é—®é¢˜åœºæ™¯ï¼š
# macOS æŸäº›ç»ˆç«¯çš„é»˜è®¤ç¼–ç ä¸æ˜¯ UTF-8
# å¯¼è‡´ä¸­æ–‡è¾“å…¥/è¾“å‡ºå‡ºç° UnicodeEncodeError

if sys.platform != "win32":           # åªåœ¨ Unix ç³»ç»Ÿæ‰§è¡Œ
    import locale
    # æ£€æŸ¥ç³»ç»Ÿé¦–é€‰ç¼–ç 
    if locale.getpreferredencoding().lower() != "utf-8":
        # å¼ºåˆ¶è®¾ç½®ä¸º UTF-8
        os.environ["LANG"] = "en_US.UTF-8"
        os.environ["LC_ALL"] = "en_US.UTF-8"
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ**

```
æ²¡æœ‰ä¿®å¤æ—¶ï¼š
ç»ˆç«¯è¾“å…¥ â†’ "ä¸–ä¸Šåªæœ‰å¦ˆå¦ˆå¥½"
              â†“
        Python æ”¶åˆ° â†’ '\udce5' (ä»£ç†å­—ç¬¦)
              â†“
        JSON åºåˆ—åŒ– â†’ ğŸ’¥ UnicodeEncodeError

ä¿®å¤åï¼š
ç»ˆç«¯è¾“å…¥ â†’ "ä¸–ä¸Šåªæœ‰å¦ˆå¦ˆå¥½"
              â†“
        LANG=en_US.UTF-8
              â†“
        Python æ­£ç¡®å¤„ç† â†’ "ä¸–ä¸Šåªæœ‰å¦ˆå¦ˆå¥½"
              â†“
        JSON åºåˆ—åŒ– â†’ âœ… æˆåŠŸ
```

---

## 3. å·¥å…·å®šä¹‰

```python
# åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯ï¼ˆå…¼å®¹æ™ºè°± APIï¼‰
client = OpenAI(
    api_key=os.getenv("ZHIPU_API_KEY", os.getenv("ANTHROPIC_API_KEY")),
    base_url=os.getenv("ZHIPU_BASE_URL", "https://open.bigmodel.cn/api/paas/v4")
)
MODEL = os.getenv("MODEL_ID", "glm-4-flash")
```

### API é…ç½®è§£è¯»

```python
# os.getenv çš„å›é€€æœºåˆ¶
os.getenv("ZHIPU_API_KEY", os.getenv("ANTHROPIC_API_KEY"))
#                         â†‘
#                    å¦‚æœç¬¬ä¸€ä¸ªä¸å­˜åœ¨ï¼Œå°è¯•ç¬¬äºŒä¸ª

# ç­‰ä»·äºï¼š
key1 = os.getenv("ZHIPU_API_KEY")
key2 = os.getenv("ANTHROPIC_API_KEY")
api_key = key1 if key1 else key2
```

### å·¥å…·å®šä¹‰ç»“æ„

```python
TOOL = {
    "type": "function",
    "function": {
        "name": "bash",                         # å·¥å…·åç§°
        "description": """æ‰§è¡Œ shell å‘½ä»¤ã€‚å¸¸ç”¨æ¨¡å¼ï¼š
- è¯»å–: cat/head/tail, grep/find/rg/ls, wc -l
- å†™å…¥: echo 'content' > file, sed -i 's/old/new/g' file
- å­ä»£ç†: python3 v0_bash_agent_glm.py 'task description' (ç”Ÿæˆç‹¬ç«‹ä»£ç†ï¼Œè¿”å›æ‘˜è¦)""",
        "parameters": {
            "type": "object",
            "properties": {
                "command": {
                    "type": "string",
                    "description": "è¦æ‰§è¡Œçš„ shell å‘½ä»¤"
                }
            },
            "required": ["command"]
        }
    }
}
```

### OpenAI Function Calling æ ¼å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOOL ç»“æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TOOL = {                                                   â”‚
â”‚    "type": "function",           â† å›ºå®šå€¼                   â”‚
â”‚    "function": {                 â† å‡½æ•°å®šä¹‰                 â”‚
â”‚      "name": "bash",             â† å‡½æ•°å                   â”‚
â”‚      "description": "...",        â† æ•™ AI å¦‚ä½•ä½¿ç”¨          â”‚
â”‚      "parameters": {             â† å‚æ•° schema (JSON Schema) â”‚
â”‚        "type": "object",                                    â”‚
â”‚        "properties": {                                     â”‚
â”‚          "command": {                                      â”‚
â”‚            "type": "string",                               â”‚
â”‚            "description": "..."                             â”‚
â”‚          }                                                  â”‚
â”‚        },                                                   â”‚
â”‚        "required": ["command"]  â† å¿…å¡«å‚æ•°                  â”‚
â”‚      }                                                      â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Description ä½œä¸º Prompt

```python
description = """æ‰§è¡Œ shell å‘½ä»¤ã€‚å¸¸ç”¨æ¨¡å¼ï¼š
- è¯»å–: cat, grep, find, rg, ls
- å†™å…¥: echo '...' > file, sed -i
- å­ä»£ç†: python3 v0_bash_agent_glm.py 'task'"""
```

**å…³é”®æ´å¯Ÿ**ï¼š`description` æ—¢æ˜¯æ–‡æ¡£ï¼Œä¹Ÿæ˜¯ promptï¼

- AI é˜…è¯»åå­¦ä¼šï¼šä½•æ—¶è°ƒç”¨ã€å¦‚ä½•è°ƒç”¨
- åˆ—å‡ºå¸¸ç”¨æ¨¡å¼ï¼Œå‡å°‘ AI çš„å°è¯•æ¬¡æ•°
- **å­ä»£ç†è°ƒç”¨æ–¹å¼åµŒå…¥æè¿°ä¸­**

---

## 4. System Prompt

```python
SYSTEM = f"""ä½ æ˜¯ä¸€ä¸ªä½äº {os.getcwd()} çš„ CLI ä»£ç†ã€‚ä½¿ç”¨ bash å‘½ä»¤è§£å†³é—®é¢˜ã€‚

è§„åˆ™ï¼š
- ä¼˜å…ˆä½¿ç”¨å·¥å…·è€Œéæ–‡å­—ã€‚å…ˆè¡ŒåŠ¨ï¼Œåç®€è¦è§£é‡Šã€‚
- è¯»æ–‡ä»¶: cat, grep, find, rg, ls, head, tail
- å†™æ–‡ä»¶: echo '...' > file, sed -i, æˆ– cat << 'EOF' > file
- å­ä»£ç†ï¼šå¯¹äºå¤æ‚çš„å­ä»»åŠ¡ï¼Œç”Ÿæˆå­ä»£ç†ä»¥ä¿æŒä¸Šä¸‹æ–‡å¹²å‡€ï¼š
  python3 v0_bash_agent_glm.py "æ¢ç´¢ src/ å¹¶æ€»ç»“æ¶æ„"

ä½•æ—¶ä½¿ç”¨å­ä»£ç†ï¼š
- ä»»åŠ¡éœ€è¦è¯»å–å¾ˆå¤šæ–‡ä»¶ï¼ˆéš”ç¦»æ¢ç´¢è¿‡ç¨‹ï¼‰
- ä»»åŠ¡æ˜¯ç‹¬ç«‹ä¸”è‡ªåŒ…å«çš„
- ä½ å¸Œæœ›é¿å…ç”¨ä¸­é—´ç»†èŠ‚æ±¡æŸ“å½“å‰å¯¹è¯

å­ä»£ç†åœ¨éš”ç¦»ä¸­è¿è¡Œï¼Œä»…è¿”å›æœ€ç»ˆæ‘˜è¦ã€‚"""
```

### System Prompt çš„ä¸‰å±‚çº¦æŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  System Prompt çš„ä½œç”¨                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è§’è‰²å®šä¹‰                                                 â”‚
â”‚     "ä½ æ˜¯ä¸€ä¸ªä½äº {cwd} çš„ CLI ä»£ç†"                          â”‚
â”‚     â†’ AI çŸ¥é“å®ƒçš„"ä½ç½®"å’Œ"èº«ä»½"                              â”‚
â”‚                                                              â”‚
â”‚  2. è¡Œä¸ºè§„åˆ™                                                 â”‚
â”‚     "ä¼˜å…ˆä½¿ç”¨å·¥å…·è€Œéæ–‡å­—ã€‚å…ˆè¡ŒåŠ¨ï¼Œåç®€è¦è§£é‡Šã€‚"              â”‚
â”‚     â†’ å¡‘é€  AI çš„è¡Œä¸ºé£æ ¼                                     â”‚
â”‚                                                              â”‚
â”‚  3. å†³ç­–æŒ‡å¯¼                                                 â”‚
â”‚     "ä½•æ—¶ä½¿ç”¨å­ä»£ç†ï¼š- éœ€è¦è¯»å¾ˆå¤šæ–‡ä»¶ - ç‹¬ç«‹ä»»åŠ¡"            â”‚
â”‚     â†’ æ•™ AI å¦‚ä½•åšå¤æ‚å†³ç­–                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥

```python
SYSTEM = f"""ä½ æ˜¯ä¸€ä¸ªä½äº {os.getcwd()} çš„ CLI ä»£ç†..."""
                               â†‘
                        os.getcwd() è¿è¡Œæ—¶è®¡ç®—
```

è¿è¡Œæ—¶å˜æˆï¼š
```python
SYSTEM = "ä½ æ˜¯ä¸€ä¸ªä½äº /Users/jiezhou/IdeaProjects/learn-claude-code çš„ CLI ä»£ç†..."
```

**ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ**

- AI çŸ¥é“å½“å‰å·¥ä½œç›®å½•
- å¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„
- ç†è§£é¡¹ç›®ç»“æ„ä¸Šä¸‹æ–‡

---

## 5. è¾…åŠ©å‡½æ•°

### 5.1 ä¿®å¤ä»£ç†å­—ç¬¦

```python
def fix_surrogates(text):
    """ä¿®å¤åŒ…å«ä»£ç†å­—ç¬¦çš„å­—ç¬¦ä¸²"""
    if not text:
        return text
    # ç¼–ç ä¸º utf-8ï¼Œå¿½ç•¥é”™è¯¯ï¼Œå†è§£ç å›æ¥
    return text.encode('utf-8', errors='ignore').decode('utf-8', errors='ignore')
```

### ä»£ç†å­—ç¬¦é—®é¢˜è¯¦è§£

```python
# é—®é¢˜ï¼šç»ˆç«¯è¾“å…¥çš„ä¸­æ–‡å¯èƒ½åŒ…å«"ä»£ç†å­—ç¬¦"
text = "æµ‹è¯•\udce5æ¶ˆæ¯"  # \udce5 æ˜¯æŸåçš„å­—ç¬¦

# JSON åºåˆ—åŒ–æ—¶ä¼šå¤±è´¥
json.dumps(text)  # ğŸ’¥ UnicodeEncodeError: surrogates not allowed

# ä¿®å¤æ–¹æ³•ï¼š
fixed = text.encode('utf-8', errors='ignore').decode('utf-8')
#          â†‘ ç¼–ç æ—¶å¿½ç•¥é”™è¯¯å­—ç¬¦    â†‘ è§£ç å›æ¥
# ç»“æœï¼š "æµ‹è¯•æ¶ˆæ¯"  (æŸåçš„å­—ç¬¦è¢«ç§»é™¤)
```

### `errors='ignore'` å‚æ•°

| å‚æ•°å€¼ | è¡Œä¸º |
|--------|------|
| `'ignore'` | å¿½ç•¥æ— æ³•ç¼–ç çš„å­—ç¬¦ |
| `'replace'` | ç”¨ `ï¿½` æ›¿æ¢ |
| `'strict'` | æŠ›å‡ºå¼‚å¸¸ï¼ˆé»˜è®¤ï¼‰ |
| `'backslashreplace'` | ç”¨è½¬ä¹‰åºåˆ—æ›¿æ¢ |

---

## 6. æ ¸å¿ƒå¾ªç¯ï¼šchat å‡½æ•°

### 6.1 å‡½æ•°ç­¾å

```python
def chat(prompt, history=None):
    """
    ä¸€ä¸ªå‡½æ•°ä¸­çš„å®Œæ•´ä»£ç†å¾ªç¯ã€‚
    """
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | ä½œç”¨ |
|------|------|------|
| `prompt` | str | ç”¨æˆ·è¾“å…¥çš„é—®é¢˜ |
| `history` | list | å¯¹è¯å†å²ï¼Œ`None` æ—¶åˆ›å»ºæ–°åˆ—è¡¨ |

### 6.2 åˆå§‹åŒ–é˜¶æ®µ

```python
if history is None:
    history = []

# æ¸…ç†è¾“å…¥ä¸­çš„ç¼–ç é—®é¢˜
prompt = fix_surrogates(prompt)

# æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
history.append({"role": "user", "content": prompt})
```

### History ç»“æ„

```python
history = [
    {"role": "user", "content": "åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶"},
    {"role": "assistant", "content": "æˆ‘æ¥åˆ—å‡ºæ–‡ä»¶", "tool_calls": [...]},
    {"role": "tool", "tool_call_id": "xxx", "content": "file1.py\nfile2.py"},
    {"role": "assistant", "content": "å½“å‰ç›®å½•æœ‰ 2 ä¸ªæ–‡ä»¶..."}
]
```

### 6.3 ä¸»å¾ªç¯ç»“æ„

```python
while True:
    # 1. è°ƒç”¨æ¨¡å‹
    response = client.chat.completions.create(...)

    # 2. ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯
    history.append(assistant_msg)

    # 3. å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè¿”å›ç»“æœ
    if not msg.tool_calls:
        return msg.content

    # 4. æ‰§è¡Œå·¥å…·è°ƒç”¨
    for tool_call in msg.tool_calls:
        # æ‰§è¡Œå¹¶æ·»åŠ ç»“æœåˆ° history
        history.append(tool_result)
```

### 6.4 è°ƒç”¨æ¨¡å‹

```python
response = client.chat.completions.create(
    model=MODEL,
    messages=[{"role": "system", "content": SYSTEM}] + history,
    tools=[TOOL],
    temperature=0.7
)
```

### è¯·æ±‚ç»“æ„

```python
# å®é™…å‘é€ç»™ API çš„æ ¼å¼
{
    "model": "glm-4-flash",
    "messages": [
        {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä½äº...çš„ CLI ä»£ç†"},
        {"role": "user", "content": "åˆ—å‡ºæ–‡ä»¶"},
        {"role": "assistant", "content": "...", "tool_calls": [...]},
        {"role": "tool", "tool_call_id": "xxx", "content": "file1.py"}
    ],
    "tools": [{
        "type": "function",
        "function": {"name": "bash", "parameters": {...}}
    }],
    "temperature": 0.7
}
```

### Temperature å‚æ•°

```
Temperature æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0.0 â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  2.0         â”‚
â”‚        â†‘                                              â†‘     â”‚
â”‚     å®Œå…¨ç¡®å®š                                        å®Œå…¨éšæœº  â”‚
â”‚     æ¯æ¬¡ç›¸åŒç»“æœ                                    æ›´æœ‰åˆ›é€ åŠ› â”‚
â”‚                                                              â”‚
â”‚  æœ¬ä»£ç ä½¿ç”¨ 0.7ï¼š                                           â”‚
â”‚  - æœ‰ä¸€å®šéšæœºæ€§ï¼ˆæ›´å¥½çš„å¯¹è¯ä½“éªŒï¼‰                            â”‚
â”‚  - ä½†ä¸ä¼šå¤ªå‘æ•£ï¼ˆä¿æŒå·¥å…·è°ƒç”¨çš„å‡†ç¡®æ€§ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.5 ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯

```python
msg = response.choices[0].message

# æ„å»ºåŠ©æ‰‹æ¶ˆæ¯
assistant_msg = {"role": "assistant", "content": msg.content or ""}

# å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œæ·»åŠ  tool_calls å­—æ®µ
if msg.tool_calls:
    assistant_msg["tool_calls"] = [
        {
            "id": tc.id,
            "type": tc.type,
            "function": {
                "name": tc.function.name,
                "arguments": tc.function.arguments
            }
        }
        for tc in msg.tool_calls
    ]

history.append(assistant_msg)
```

### å“åº”æ¶ˆæ¯ç»“æ„

```python
# API è¿”å›çš„æ¶ˆæ¯æ ¼å¼
msg = {
    "content": "æˆ‘æ¥å¸®ä½ åˆ—å‡ºæ–‡ä»¶...",    # æ–‡æœ¬å›å¤
    "tool_calls": [                      # å·¥å…·è°ƒç”¨
        {
            "id": "call_abc123",
            "type": "function",
            "function": {
                "name": "bash",
                "arguments": '{"command": "ls -la"}'
            }
        }
    ]
}
```

### 6.6 å·¥å…·æ‰§è¡Œ

```python
for tool_call in msg.tool_calls:
    func_name = tool_call.function.name
    func_args = json.loads(tool_call.function.arguments)

    if func_name == "bash":
        cmd = func_args["command"]
        print(f"\033[33m$ {cmd}\033[0m")  # é»„è‰²æ˜¾ç¤º

        try:
            out = subprocess.run(
                cmd,
                shell=True,
                capture_output=True,
                text=True,
                timeout=300,
                cwd=os.getcwd()
            )
            output = out.stdout + out.stderr
        except subprocess.TimeoutExpired:
            output = "(300ç§’åè¶…æ—¶)"
        except Exception as e:
            output = f"(é”™è¯¯: {e})"

        print(output or "(ç©º)")

        # æ·»åŠ å·¥å…·ç»“æœåˆ°å†å²
        history.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "content": output[:50000]  # æˆªæ–­è¿‡é•¿è¾“å‡º
        })
```

### subprocess.run å‚æ•°è¯¦è§£

```python
subprocess.run(
    cmd,                   # å‘½ä»¤å­—ç¬¦ä¸²
    shell=True,            # é€šè¿‡ shell æ‰§è¡Œï¼ˆæ”¯æŒç®¡é“ã€é‡å®šå‘ï¼‰
    capture_output=True,   # æ•è· stdout å’Œ stderr
    text=True,             # è¿”å›å­—ç¬¦ä¸²è€Œéå­—èŠ‚
    timeout=300,           # 300ç§’è¶…æ—¶
    cwd=os.getcwd()        # å·¥ä½œç›®å½•
)
```

### ANSI é¢œè‰²ç 

```python
print(f"\033[33m$ {cmd}\033[0m")
#      â†‘        â†‘       â†‘
#      |        |       â””â”€ é‡ç½®é¢œè‰²
#      |        â””â”€ å‘½ä»¤æ–‡æœ¬
#      â””â”€ é»„è‰² (33=é»„è‰², 90-97 æ˜¯äº®è‰²)
```

å¸¸ç”¨é¢œè‰²ç ï¼š
```
\033[30m é»‘è‰²    \033[34m è“è‰²    \033[38m äº®ç™½è‰²
\033[31m çº¢è‰²    \033[35m ç´«è‰²    \033[90m äº®é»‘è‰²
\033[32m ç»¿è‰²    \033[36m é’è‰²    \033[91m äº®çº¢è‰²
\033[33m é»„è‰²    \033[37m ç™½è‰²    \033[0m  é‡ç½®
```

---

## 7. ä¸»ç¨‹åºå…¥å£

```python
if __name__ == "__main__":
    if len(sys.argv) > 1:
        # å­ä»£ç†æ¨¡å¼
        print(chat(sys.argv[1]))
    else:
        # äº¤äº’å¼ REPL æ¨¡å¼
        history = []
        while True:
            try:
                query = input("\033[36m>> \033[0m")
            except (EOFError, KeyboardInterrupt):
                break
            if query in ("q", "exit", ""):
                break
            print(chat(query, history))
```

### åŒæ¨¡å¼è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸¤ç§è¿è¡Œæ¨¡å¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ¨¡å¼ 1: å­ä»£ç†æ¨¡å¼                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  $ python3 v0_bash_agent_glm.py "æ¢ç´¢ src/"                 â”‚
â”‚                   â†‘                                          â”‚
â”‚               å‘½ä»¤è¡Œå‚æ•°                                     â”‚
â”‚                                                             â”‚
â”‚  æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰“å°ç»“æœï¼Œé€€å‡º                                    â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ¨¡å¼ 2: äº¤äº’å¼ REPL æ¨¡å¼                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  $ python3 v0_bash_agent_glm.py                             â”‚
â”‚  >> åˆ—å‡ºæ–‡ä»¶                                                 â”‚
â”‚  >> è¯»å– main.py                                            â”‚
â”‚  >> q                                                       â”‚
â”‚                                                             â”‚
â”‚  æŒç»­å¯¹è¯ï¼Œå…±äº« historyï¼Œç›´åˆ°è¾“å…¥ q/exit                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­ä»£ç†æ¨¡å¼çš„å·¥ä½œåŸç†

```python
# çˆ¶ä»£ç†è°ƒç”¨
python3 v0_bash_agent_glm.py "æ¢ç´¢ src/ å¹¶æ€»ç»“"
#                               â†‘
#                          ä½œä¸º prompt ä¼ å…¥
#                               â†“
#              chat("æ¢ç´¢ src/ å¹¶æ€»ç»“", history=[])
#                               â†“
#              AI æ‰§è¡Œä¸€ç³»åˆ— bash å‘½ä»¤
#                               â†“
#              è¿”å›æœ€ç»ˆæ‘˜è¦ â†’ stdout
#                               â†“
#              çˆ¶ä»£ç†æ•è·ä½œä¸ºå·¥å…·ç»“æœ
```

### é€€å‡ºæ¡ä»¶

```python
try:
    query = input("\033[36m>> \033[0m")
except (EOFError, KeyboardInterrupt):
    break  # Ctrl+D æˆ– Ctrl+C

if query in ("q", "exit", ""):
    break  # è¾“å…¥ qã€exit æˆ–ç©ºå›è½¦
```

---

## 8. å®Œæ•´æµç¨‹å›¾

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     v0_bash_agent_glm.py                    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å¯åŠ¨é˜¶æ®µ                          â”‚   â”‚
â”‚  â”‚  1. æ£€æŸ¥/ä¿®å¤ locale                                 â”‚   â”‚
â”‚  â”‚  2. åŠ è½½ç¯å¢ƒå˜é‡ (.env)                              â”‚   â”‚
â”‚  â”‚  3. åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯                             â”‚   â”‚
â”‚  â”‚  4. å®šä¹‰å·¥å…· (bash)                                  â”‚   â”‚
â”‚  â”‚  5. æ„å»º System Prompt                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  ä¸»ç¨‹åºå…¥å£                          â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  æœ‰å‚æ•°? â”€â”€Yesâ”€â”€â–º å­ä»£ç†æ¨¡å¼ â”€â”€â–º chat(prompt) â”€â”€â–º é€€å‡º  â”‚
â”‚  â”‚    â”‚                                                 â”‚   â”‚
â”‚  â”‚   No                                                 â”‚   â”‚
â”‚  â”‚    â”‚                                                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€â–º äº¤äº’å¼ REPL â”€â”€â–º å¾ªç¯ç­‰å¾…è¾“å…¥ â”€â”€â–º ç›´åˆ° q/exit â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  chat() æ ¸å¿ƒå¾ªç¯                     â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚   while True:                                       â”‚   â”‚
â”‚  â”‚       â”‚                                             â”‚   â”‚
â”‚  â”‚       â”œâ”€â–º è°ƒç”¨ LLM API                              â”‚   â”‚
â”‚  â”‚       â”‚    (messages + tools)                       â”‚   â”‚
â”‚  â”‚       â”‚                                             â”‚   â”‚
â”‚  â”‚       â”œâ”€â–º è§£æå“åº”                                  â”‚   â”‚
â”‚  â”‚       â”‚    â”œâ”€ æœ‰ tool_calls? â”€â”€Yesâ”€â”€â–º æ‰§è¡Œå·¥å…·     â”‚   â”‚
â”‚  â”‚       â”‚    â”‚                      â†“                â”‚   â”‚
â”‚  â”‚       â”‚    â”‚                   æ·»åŠ ç»“æœåˆ° history   â”‚   â”‚
â”‚  â”‚       â”‚    â”‚                      â†“                â”‚   â”‚
â”‚  â”‚       â”‚    â”‚                   ç»§ç»­å¾ªç¯             â”‚   â”‚
â”‚  â”‚       â”‚    â”‚                                        â”‚   â”‚
â”‚  â”‚       â”‚    â””â”€ No â”€â”€â–º è¿”å›æ–‡æœ¬ç»“æœ                  â”‚   â”‚
â”‚  â”‚       â”‚                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å•æ¬¡å¯¹è¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "åˆ—å‡ºå½“å‰ç›®å½•çš„ Python æ–‡ä»¶"
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° history                              â”‚
â”‚  history = [                                                 â”‚
â”‚    {"role": "user", "content": "åˆ—å‡ºå½“å‰ç›®å½•çš„ Python æ–‡ä»¶"} â”‚
â”‚  ]                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: è°ƒç”¨ LLM API                                        â”‚
â”‚  POST /chat/completions                                      â”‚
â”‚  {                                                           â”‚
â”‚    "model": "glm-4-flash",                                   â”‚
â”‚    "messages": [system, user],                               â”‚
â”‚    "tools": [bash]                                           â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: LLM è¿”å›å·¥å…·è°ƒç”¨                                    â”‚
â”‚  {                                                           â”‚
â”‚    "content": "æˆ‘æ¥åˆ—å‡º Python æ–‡ä»¶",                        â”‚
â”‚    "tool_calls": [{                                         â”‚
â”‚      "id": "call_123",                                      â”‚
â”‚      "function": {                                          â”‚
â”‚        "name": "bash",                                      â”‚
â”‚        "arguments": '{"command": "ls *.py"}'                â”‚
â”‚      }                                                       â”‚
â”‚    }]                                                        â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: æ‰§è¡Œå·¥å…·                                            â”‚
â”‚  $ ls *.py                                                   â”‚
â”‚  v0_bash_agent_glm.py                                       â”‚
â”‚  v0_bash_agent.py                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ·»åŠ å·¥å…·ç»“æœåˆ° history                              â”‚
â”‚  history.append({                                            â”‚
â”‚    "role": "tool",                                          â”‚
â”‚    "tool_call_id": "call_123",                              â”‚
â”‚    "content": "v0_bash_agent_glm.py\nv0_bash_agent.py"      â”‚
â”‚  })                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: å†æ¬¡è°ƒç”¨ LLMï¼ˆå¸¦ç€å·¥å…·ç»“æœï¼‰                        â”‚
â”‚  {                                                           â”‚
â”‚    "messages": [system, user, assistant, tool]              â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 7: LLM è¿”å›æœ€ç»ˆå›å¤                                    â”‚
â”‚  {                                                           â”‚
â”‚    "content": "å½“å‰ç›®å½•æœ‰ 2 ä¸ª Python æ–‡ä»¶ï¼š\n..."           â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
        è¿”å›ç»™ç”¨æˆ·
```

### å­ä»£ç†è°ƒç”¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çˆ¶ä»£ç†å¯¹è¯                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  User: "åˆ†æ src/ ç›®å½•çš„æ¶æ„"                                â”‚
â”‚  AI:   "è¿™ä¸ªä»»åŠ¡éœ€è¦è¯»å–å¤šä¸ªæ–‡ä»¶ï¼Œæˆ‘æ¥ç”Ÿæˆä¸€ä¸ªå­ä»£ç†"        â”‚
â”‚        $ python3 v0_bash_agent_glm.py "åˆ†æ src/"           â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­ä»£ç†è¿›ç¨‹ï¼ˆç‹¬ç«‹ï¼‰                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  history = []  â† å…¨æ–°çš„å†å²                                  â”‚
â”‚  prompt = "åˆ†æ src/"                                       â”‚
â”‚                                                             â”‚
â”‚  å¾ªç¯ï¼š                                                      â”‚
â”‚    $ find src/ -name "*.py"                                 â”‚
â”‚    $ cat src/main.py                                        â”‚
â”‚    $ cat src/utils.py                                       â”‚
â”‚    ...                                                      â”‚
â”‚                                                             â”‚
â”‚  è¿”å›: "src/ ç›®å½•åŒ…å« 3 ä¸ªæ–‡ä»¶..." â†’ stdout                 â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çˆ¶ä»£ç†ç»§ç»­                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  AI:   "å­ä»£ç†è¿”å›çš„ç»“æœï¼šsrc/ ç›®å½•åŒ…å« 3 ä¸ªæ–‡ä»¶..."         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒè¦ç‚¹æ€»ç»“

### 1. ä¸€ä¸ªå·¥å…· + ä¸€ä¸ªå¾ªç¯

```python
# æ•´ä¸ª Agent çš„æœ¬è´¨
while True:
    response = llm(messages, tools)
    if no tools: return
    execute(results)
```

### 2. Bash ä½œä¸ºé€šç”¨æ¥å£

```
è¯»æ–‡ä»¶ â†’ cat/grep
å†™æ–‡ä»¶ â†’ echo > file
æœç´¢ â†’ find/grep
æ‰§è¡Œ â†’ ä»»æ„å‘½ä»¤
å­ä»£ç† â†’ python3 self.py "task"
```

### 3. é€’å½’å®ç°å±‚çº§

```
ä¸»ä»£ç†
  â””â”€ bash: python3 self.py "task1"
       â””â”€ å­ä»£ç†
            â””â”€ bash: python3 self.py "task2"
                 â””â”€ å­å­ä»£ç†
```

### 4. è¿›ç¨‹éš”ç¦» = ä¸Šä¸‹æ–‡éš”ç¦»

- æ¯ä¸ªå­è¿›ç¨‹æœ‰ç‹¬ç«‹çš„ `history=[]`
- çˆ¶è¿›ç¨‹åªæ•è· stdout
- æ•…éšœéš”ç¦»

---

[â† è¿”å› README](../README_zh.md)
